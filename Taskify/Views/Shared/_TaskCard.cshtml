<!DOCTYPE html>

@model Taskify.Models.TaskDetailsViewModel

@{
    var priorityClass = Model.Priority switch
    {
        TaskPriority.High => "danger",
        TaskPriority.Medium => "warning",
        TaskPriority.Low => "success",
        _ => "secondary"
    };

    var priorityIcon = Model.Priority switch
    {
        TaskPriority.High => "fa-exclamation-circle",
        TaskPriority.Medium => "fa-exclamation-triangle",
        TaskPriority.Low => "fa-circle",
        _ => "fa-circle"
    };

    var statusClass = Model.Status switch
    {
        Taskify.Models.TaskStatus.Completed => "success",
        Taskify.Models.TaskStatus.InProgress => "primary",
        Taskify.Models.TaskStatus.Cancelled => "secondary",
        _ => "warning"
    };

    var statusText = Model.Status switch
    {
        Taskify.Models.TaskStatus.Completed => "Completed",
        Taskify.Models.TaskStatus.InProgress => "In Progress",
        Taskify.Models.TaskStatus.Cancelled => "Cancelled",
        Taskify.Models.TaskStatus.Pending => "Pending",
        _ => "Unknown"
    };

    var isOverdue = Model.DueDate.HasValue && Model.DueDate.Value < DateTime.Now && Model.Status != Taskify.Models.TaskStatus.Completed;
    var isCompleted = Model.Status == Taskify.Models.TaskStatus.Completed;
}

<div class="task-card @(isCompleted ? "completed" : "") @(isOverdue ? "overdue" : "")" data-task-id="@Model.Id">
    <!-- Card Header -->
    <div class="task-card-header">
        <div class="d-flex align-items-start">
            <!-- Checkbox -->
            <div class="form-check me-3">
                <input class="form-check-input task-checkbox"
                       type="checkbox"
                       id="task-@Model.Id"
                       @(isCompleted ? "checked" : "")
                       onchange="toggleTaskComplete(@Model.Id, this.checked)">
            </div>

            <!-- Task Info -->
            <div class="flex-grow-1">
                <h5 class="task-title mb-2">
                    <a href="@Url.Action("Details", "Tasks", new { id = Model.Id })">
                        @Model.Title
                    </a>
                </h5>

                @if (!string.IsNullOrEmpty(Model.Decription))
                {
                    <p class="task-description text-muted mb-2">
                        @(Model.Decription.Length > 100 ? Model.Decription.Substring(0, 100) + "..." : Model.Decription)
                    </p>
                }

                <!-- Task Meta -->
                <div class="task-meta">
                    @if (!string.IsNullOrEmpty(Model.CategoryName))
                    {
                        <span class="badge bg-info bg-opacity-10 text-info me-2">
                            <i class="fas fa-folder me-1"></i>@Model.CategoryName
                        </span>
                    }

                    <span class="badge bg-@priorityClass bg-opacity-10 text-@priorityClass me-2">
                        <i class="fas @priorityIcon me-1"></i>@Model.Priority
                    </span>

                    @if (Model.DueDate.HasValue)
                    {
                        var daysUntilDue = (Model.DueDate.Value - DateTime.Now).Days;
                        var dueDateClass = isOverdue ? "danger" : (daysUntilDue <= 1 ? "warning" : "secondary");

                        <span class="badge bg-@dueDateClass bg-opacity-10 text-@dueDateClass">
                            <i class="fas fa-calendar me-1"></i>
                            @if (isOverdue)
                            {
                                <text>Overdue @Math.Abs(daysUntilDue) days</text>
                            }
                            else if (daysUntilDue == 0)
                            {
                                <text>Today</text>
                            }
                            else if (daysUntilDue == 1)
                            {
                                <text>Tomorrow</text>
                            }
                            else
                            {
                                @Model.DueDate.Value.ToString("MMM dd, yyyy")
                            }
                        </span>
                    }
                </div>
            </div>

            <!-- Actions Dropdown -->
            <div class="dropdown">
                <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item" href="@Url.Action("Edit", "Tasks", new { id = Model.Id })">
                            <i class="fas fa-edit me-2"></i>Edit
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="@Url.Action("Details", "Tasks", new { id = Model.Id })">
                            <i class="fas fa-eye me-2"></i>View Details
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item text-danger" onclick="deleteTask(@Model.Id)">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="task-status-bar bg-@statusClass"></div>
</div>

<style>
    .task-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .task-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .task-card.completed {
        opacity: 0.7;
        background: #f9fafb;
    }

    .task-card.completed .task-title {
        text-decoration: line-through;
        color: #9ca3af;
    }

    .task-card.overdue {
        border-left: 4px solid var(--danger-color);
    }

    .task-card-header {
        position: relative;
        z-index: 1;
    }

    .task-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid #d1d5db;
        margin-top: 3px;
    }

    .task-checkbox:checked {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }

    .task-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .task-title a {
        color: var(--dark-color);
        text-decoration: none;
    }

    .task-title a:hover {
        color: var(--primary-color);
    }

    .task-description {
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
    }

    .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }

    .task-meta .badge {
        font-size: 0.75rem;
        padding: 5px 10px;
        font-weight: 500;
        border-radius: 6px;
    }

    .task-status-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .dropdown-toggle::after {
        display: none;
    }

    @@media (max-width: 576px) {
        .task-card {
            padding: 15px;
        }

        .task-title {
            font-size: 1rem;
        }

        .task-meta .badge {
            font-size: 0.7rem;
            padding: 4px 8px;
        }
    }
</style>

<script>
    function toggleTaskComplete(taskId, isCompleted) {
        const newStatus = isCompleted ? 'Completed' : 'Pending';

        fetch(`/Tasks/UpdateStatus/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => {
            if (response.ok) {
                const card = document.querySelector(`[data-task-id="${taskId}"]`);
                if (isCompleted) {
                    card.classList.add('completed');
                } else {
                    card.classList.remove('completed');
                }
                location.reload(); // Reload để cập nhật counters
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            fetch(`/Tasks/Delete/${taskId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    const card = document.querySelector(`[data-task-id="${taskId}"]`);
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        card.remove();
                        location.reload();
                    }, 300);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
</script>
