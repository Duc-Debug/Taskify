@model Taskify.Models.TeamDetailsViewModel
@{
    ViewData["Title"] = Model.Name;
}
@section Styles {
    <link rel="stylesheet" href="~/css/teams.css" asp-append-version="true" />
}
<div class="team-details-container">
    <!-- Team Header -->
    <div class="team-header">
        <a asp-action="Index" class="btn-back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
        </a>

        <div class="team-header-content">
            <div class="team-info">
                <div class="team-avatar-large">
                    <span>@Model.Name.Substring(0, Math.Min(2, Model.Name.Length)).ToUpper()</span>
                </div>
                <div>
                    <h1 class="team-name">@Model.Name</h1>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="team-description">@Model.Description</p>
                    }
                    <div class="team-meta">
                        <span class="meta-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                            @Model.Members.Count members
                        </span>
                        <span class="meta-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <line x1="9" y1="3" x2="9" y2="21" />
                            </svg>
                            @Model.Boards.Count boards
                        </span>
                        <span class="meta-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            Created @Model.CreatedAt.ToString("MMM dd, yyyy")
                        </span>
                    </div>
                </div>
            </div>

            @if (Model.IsOwner)
            {
                <div class="team-actions">
                    <button class="btn btn-secondary" type="button" onclick="event.preventDefault(); event.stopPropagation(); openEditTeamModal('@Model.Id');">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                        Edit Team
                    </button>
                    <div class="dropdown">
                        <button class="btn-icon" data-bs-toggle="dropdown">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1" />
                                <circle cx="12" cy="5" r="1" />
                                <circle cx="12" cy="19" r="1" />
                            </svg>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item cursor-pointer" href="#"
                                   data-bs-toggle="modal" data-bs-target="#settingTeamModal">Team Settings
                               </a>
                            </li>
                            <li><a class="dropdown-item" href="#">Export Data</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <form asp-action="Delete" asp-controller="Teams" asp-route-id="@Model.Id" method="post"
                                          class="d-inline"
                                          onsubmit="event.stopPropagation(); return confirm('Are you sure to delete this team?');">
                                <button type="submit" class="dropdown-item text-danger w-100 text-start">Delete Team</button>
                            </form>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
        <button class="tab-btn active" data-tab="members">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
            Members
            <span class="tab-count">@Model.Members.Count</span>
        </button>
        <button class="tab-btn" data-tab="boards">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <line x1="9" y1="3" x2="9" y2="21" />
            </svg>
            Boards
            <span class="tab-count">@Model.Boards.Count</span>
        </button>
        <button class="tab-btn" data-tab="activity">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
            </svg>
            Activity
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tabs-content">
        <!-- Members Tab -->
        <div class="tab-panel active" id="members-panel">
            <div class="panel-header">
                <h2>Team Members</h2>
                @if (Model.IsOwner || Model.IsAdmin)
                    {
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="8.5" cy="7" r="4" />
                            <line x1="20" y1="8" x2="20" y2="14" />
                            <line x1="23" y1="11" x2="17" y2="11" />
                        </svg>
                        Add Member
                    </button>
                }
            </div>

            <div class="members-list">
                @foreach (var member in Model.Members)
                {
                    <div class="member-card">
                        <div class="member-avatar-wrapper">
                            @if (!string.IsNullOrEmpty(member.AvatarUrl))
                            {
                                <img src="@member.AvatarUrl" alt="@member.FullName" class="member-avatar-lg" />
                            }
                            else
                            {
                                <div class="member-avatar-lg">@member.Initials</div>
                            }
                            @if (member.IsOnline)
                            {
                                <span class="online-indicator"></span>
                            }
                        </div>
                        <div class="member-info">
                            <h4>@member.FullName</h4>
                            <p>@member.Email</p>
                        </div>
                        <div class="member-role">
                            @if (member.RoleName=="Owner")
                            {
                                <span class="role-badge owner">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                    </svg>
                                    Owner
                                </span>
                            }
                            else if (member.RoleName == "Admin")
                            {
                                <span class="role-badge" style="background: #e0e7ff; color: #4338ca;">
                                    Admin
                                </span>
                            }
                            else
                            {
                                <span class="role-badge member">Member</span>
                            }
                        </div>
                        @if (Model.IsOwner && !member.IsOwner)
                        {
                            <div class="member-actions">
                                <div class="dropdown d-inline-block">
                                    <button class="btn-icon-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Change Role">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="1" />
                                            <circle cx="12" cy="5" r="1" />
                                            <circle cx="12" cy="19" r="1" />
                                        </svg>
                                    </button>

                                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="min-width: 200px;">
                                        <li><h6 class="dropdown-header text-uppercase text-xs font-weight-bolder opacity-6">Change Role</h6></li>

                                        <li>
                                            <form asp-action="ChangeMemberRole" asp-controller="Teams" method="post">
                                                <input type="hidden" name="teamId" value="@Model.Id" />
                                                <input type="hidden" name="memberId" value="@member.Id" />
                                                <input type="hidden" name="newRole" value="1" />
                                                <button type="submit" class="dropdown-item">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-secondary"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                    Set as Member
                                                </button>
                                            </form>
                                        </li>

                                        <li>
                                            <form asp-action="ChangeMemberRole" asp-controller="Teams" method="post">
                                                <input type="hidden" name="teamId" value="@Model.Id" />
                                                <input type="hidden" name="memberId" value="@member.Id" />
                                                <input type="hidden" name="newRole" value="2" />
                                                <button type="submit" class="dropdown-item text-primary">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                                                    Set as Admin
                                                </button>
                                            </form>
                                        </li>

                                        <li><hr class="dropdown-divider"></li>

                                        <li>
                                            <form asp-action="ChangeMemberRole" asp-controller="Teams" method="post">
                                                <input type="hidden" name="teamId" value="@Model.Id" />
                                                <input type="hidden" name="memberId" value="@member.Id" />
                                                <input type="hidden" name="newRole" value="3" />
                                                <button type="submit" class="dropdown-item text-warning">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                                    Transfer Owner
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                                <button class="btn-icon-sm danger" title="Remove Member" onclick="removeMember('@member.Id')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18" />
                                        <line x1="6" y1="6" x2="18" y2="18" />
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Boards Tab -->
        <div class="tab-panel" id="boards-panel">
            <div class="panel-header">
                <h2>Team Boards</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBoardModal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Create Board
                </button>
            </div>

            @if (Model.Boards != null && Model.Boards.Any())
            {
                <div class="boards-grid">
                    @foreach (var board in Model.Boards)
                    {
                        <a asp-controller="Boards" asp-action="Details" asp-route-id="@board.Id" class="board-card">
                            <div class="board-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                    <line x1="9" y1="3" x2="9" y2="21" />
                                </svg>
                            </div>
                            <h3>@board.Name</h3>
                            <div class="board-stats">
                                <span>@board.Lists.Count lists</span>
                                <span>•</span>
                                <span>@board.Lists.Sum(l => l.Tasks.Count) tasks</span>
                            </div>
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="empty-panel">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <line x1="9" y1="3" x2="9" y2="21" />
                    </svg>
                    <h3>No boards yet</h3>
                    <p>Create your first board to get started</p>
                </div>
            }
        </div>

        <!-- Activity Tab -->
        <div class="tab-panel" id="activity-panel">
            <div class="activity-feed mt-4">
        @if (Model.Activities != null && Model.Activities.Any())
        {
            <div class="list-group list-group-flush">
                @foreach (var act in Model.Activities)
                {
                    <div class="list-group-item px-0 py-3 border-bottom-0 d-flex align-items-start gap-3">
                        @if (!string.IsNullOrEmpty(act.User?.AvatarUrl))
                        {
                            <img src="@act.User.AvatarUrl" class="rounded-circle border" width="36" height="36" style="object-fit:cover">
                        }
                        else
                        {
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold" 
                                 style="width:36px; height:36px; font-size:14px">
                                @(act.User?.FullName?.Substring(0, 1) ?? "U")
                            </div>
                        }

                        <div class="flex-grow-1">
                            <div class="small text-dark">
                                <span class="fw-bold">@act.User?.FullName</span> 
                                @act.Content
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                @act.CreatedAt.ToString("dd 'thg' MM 'lúc' HH:mm")
                            </div>
                        </div>
                        
                        <div class="text-muted">
                           @if(act.Type == Taskify.Models.ActivityType.BoardCreated) {
                               <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                           } else if (act.Type == Taskify.Models.ActivityType.MemberJoined) {
                               <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                           }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center text-muted py-5">
                <svg class="mb-2" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#dee2e6" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                <div>Chưa có hoạt động nào được ghi nhận.</div>
            </div>
        }
    </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<partial name="_AddMemberModal" model="Model" />
<div id="edit-team-modal-container"></div>
<partial name="_SettingTeamModal" 
         model='new Taskify.Models.TeamSettingViewModel { 
             TeamId = Model.Id, 
             TeamName = Model.Name, 
             IsInviteApprovalRequired = Model.IsInviteApprovalRequired 
         }' />
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;

                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Update active panel
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(tabName + '-panel').classList.add('active');
            });
        });

        function removeMember(memberId) {
            if (confirm('Are you sure you want to remove this member?')) {
                fetch(`/Teams/RemoveMember`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teamId: '@Model.Id', memberId: memberId })
                })
                .then(response => {
                    if (response.ok) location.reload();
                });
            }
        }
        function openEditTeamModal(teamId) {
            fetch(`/Teams/Edit/${teamId}`)
                .then(res => res.text())
                .then(html => {
                    const container = document.getElementById('edit-team-modal-container');
                    container.innerHTML = html;
                    const modal = new bootstrap.Modal(container.querySelector('.modal'));
                    modal.show();
                });
        }
        function openSettingTeamModal(teamId){
            fetch(`/Teams/Settings/${teamId}`)
                .then(response=> response.text())
                .then(html=>{
                    const containter = document.getElementById('setting-team-modal-container');
                    containter.innerHTML = html;
                    const modalEl = containter.querySelector('.modal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.Show();
                });
        }
    </script>

