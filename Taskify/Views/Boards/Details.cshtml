@model Taskify.Models.BoardViewModel
@{
    ViewData["Title"] = Model.Name;
}

<div class="dashboard-container">
    <div class="welcome-section mb-4">
        <div class="welcome-content">
            <h1 class="text-white">@Model.Name</h1>
            <p class="text-white-50 mb-0">Drag and drop tasks to manage progress</p>
        </div>
        <div class="welcome-actions">
            <button class="btn btn-light text-primary fw-bold" onclick="alert('Feature coming soon!')">
                <i class="bi bi-plus-lg"></i> Add Member
            </button>
        </div>
    </div>

    <div class="board-canvas d-flex align-items-start gap-3 overflow-auto pb-3" style="height: calc(100vh - 200px);">

        @foreach (var list in Model.Lists)
        {
            <div class="board-list bg-light rounded-3 shadow-sm" style="min-width: 300px; max-width: 300px;">
                <div class="list-header p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark">@list.Title</h6>
                    <span class="badge bg-secondary rounded-pill">@list.Tasks.Count</span>
                </div>

                <div class="list-body p-2 gap-2 d-flex flex-column tasks-sortable"
                     data-list-id="@list.Id"
                     style="min-height: 50px; overflow-y: auto; max-height: calc(100vh - 300px);">

                    @foreach (var task in list.Tasks)
                    {
                        <partial name="~/Views/Shared/_TaskCard.cshtml" model="task" />
                    }
                </div>

                <div class="list-footer p-2">
                    <button class="btn btn-sm btn-link text-decoration-none text-secondary w-100 text-start"
                            data-bs-toggle="modal" data-bs-target="#createTaskModal"
                            onclick="setListIdForCreate('@list.Id')">
                        + Add a card
                    </button>
                </div>
            </div>
        }

        <div class="add-list-btn" style="min-width: 300px;">
            <button class="btn btn-secondary w-100 bg-opacity-25 border-0 text-start text-dark fw-bold py-3 px-3 rounded-3" style="background-color: #e9ecef;">
                + Add another list
            </button>
        </div>
    </div>
</div>

<partial name="~/Views/Tasks/_CreateModal.cshtml" model="new Taskify.Models.TaskCreateViewModel { BoardId = Model.Id }" />

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Khởi tạo Kéo Thả
            const lists = document.querySelectorAll('.tasks-sortable');

            lists.forEach(list => {
                new Sortable(list, {
                    group: 'shared-board', // Cho phép kéo qua lại giữa các cột
                    animation: 150,
                    ghostClass: 'bg-primary-subtle', // Class khi đang kéo (mờ đi)

                    // Sự kiện khi Thả chuột
                    onEnd: function (evt) {
                        const itemEl = evt.item;  // Thẻ bị kéo
                        const newIndex = evt.newIndex; // Vị trí mới
                        const toList = evt.to;    // Cột mới

                        const taskId = itemEl.getAttribute('data-task-id');
                        const targetListId = toList.getAttribute('data-list-id');

                        // Gọi API cập nhật vị trí
                        fetch('/Tasks/Move', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                taskId: taskId,
                                targetListId: targetListId,
                                newPosition: newIndex
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log("Moved successfully!");
                            } else {
                                console.error("Failed to move task");
                                // Có thể thêm logic hoàn tác (revert) nếu muốn
                            }
                        });
                    }
                });
            });
        });

        // 2. Hàm Xóa Task
        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            // Chú ý: Đường dẫn là /Tasks/Delete (số nhiều)
            fetch(`/Tasks/Delete/${taskId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    // Xóa thẻ khỏi giao diện ngay lập tức
                    const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (card) {
                        card.remove();
                        // Cập nhật lại số lượng task trên header cột (nếu cần)
                    }
                } else {
                    alert("Failed to delete task.");
                }
            });
        }

        // 3. Helper để gán ListId vào Modal khi bấm "Add a card"
        function setListIdForCreate(listId) {
            const input = document.querySelector('#createTaskForm input[name="ListId"]');
            if (input) {
                input.value = listId;
            }
        }
    </script>
}

<style>
    /* CSS tùy chỉnh cho Board */
    .board-list {
        background-color: #f1f2f4;
        max-height: 100%;
        display: flex;
        flex-direction: column;
    }

    .task-card {
        cursor: grab;
    }

        .task-card:active {
            cursor: grabbing;
        }

    /* Ẩn thanh cuộn của vùng tasks nhưng vẫn cuộn được */
    .list-body::-webkit-scrollbar {
        width: 6px;
    }

    .list-body::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 4px;
    }
</style>