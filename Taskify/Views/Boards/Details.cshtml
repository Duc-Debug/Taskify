@model Taskify.Models.BoardViewModel
@{
    ViewData["Title"] = Model.Name;
}
@section Styles {
    <link rel="stylesheet" href="~/css/kanban.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tasks.css" asp-append-version="true" />

}
<style>
    .cursor-pointer {
        cursor: pointer;
        opacity: 0.8;
        transition: 0.2s;
    }

        .cursor-pointer:hover {
            opacity: 1;
            transform: scale(1.05);
        }
</style>

<div class="kanban-container">
    <!-- Board Header -->
    <div class="board-header">
        <div class="board-info">
            <a asp-action="Index" class="btn-back">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </a>
            <div>
                <h1 class="board-name">@Model.Name</h1>
                <div class="board-meta">
                    <span class="meta-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11H3v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-6" />
                            <polyline points="22 6 12 1 2 6" />
                            <line x1="12" y1="1" x2="12" y2="11" />
                        </svg>
                        @Model.Lists.Count Lists
                    </span>
                    <span class="meta-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 11 12 14 22 4" />
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                        </svg>
                        @Model.Lists.Sum(l => l.Tasks.Count) Tasks
                    </span>
                </div>
            </div>
        </div>

        <div class="board-actions">
            <!-- Board Members -->
            @if (Model.TeamMembers != null && Model.TeamMembers.Any())
            {
                <div class="board-members">
                    @foreach (var member in Model.TeamMembers.Take(5))
                    {
                        @if (!string.IsNullOrEmpty(member.AvatarUrl))
                        {
                            <img src="@member.AvatarUrl" alt="@member.FullName" class="member-avatar" title="@member.FullName" />
                        }
                        else
                        {
                            <div class="member-avatar" title="@member.FullName">@member.Initials</div>
                        }
                    }
                    @if (Model.TeamMembers.Count > 5)
                    {
                        <button class="member-avatar more" data-bs-toggle="modal" data-bs-target="#membersModal">
                            +@(Model.TeamMembers.Count - 5)
                        </button>
                    }
                </div>
            }

            <!-- Action Buttons -->

            <button class="btn btn-icon" title="Board Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                    <circle cx="12" cy="12" r="3" />
                </svg>
            </button>

            <div class="dropdown">
                <button class="btn btn-icon" data-bs-toggle="dropdown">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1" />
                        <circle cx="12" cy="5" r="1" />
                        <circle cx="12" cy="19" r="1" />
                    </svg>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">Export Board</a></li>
                    <li><a class="dropdown-item" href="#">Archive Board</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#">Delete Board</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-board" id="kanbanBoard">
        @foreach (var list in Model.Lists.OrderBy(l => l.Order))
        {
            <div class="kanban-list" data-list-id="@list.Id">
                <!-- List Header -->
                <div class="list-header">
                    <h3 class="list-title">
                        @list.Title
                        <span class="task-count">@list.Tasks.Count</span>
                    </h3>
                    <div class="dropdown">
                        <button class="btn-list-menu" data-bs-toggle="dropdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1" />
                                <circle cx="12" cy="5" r="1" />
                                <circle cx="12" cy="19" r="1" />
                            </svg>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="addTask('@list.Id')">Add Task</a></li>
                            <li><a class="dropdown-item" href="#" onclick="renameList('@list.Id')">Rename List</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteList('@list.Id')">Delete List</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Task Cards -->
                <div class="list-tasks" data-list-id="@list.Id">
                    @foreach (var task in list.Tasks)
                    {
                        <partial name="_TaskCard" model="task" />
                    }
                </div>

                <!-- Add Task Button -->
                <button class="btn-add-task" onclick="addTask('@list.Id')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add Task
                </button>
            </div>
        }

        <!-- Add New List -->
        @if (Model.CanCreateList)
        {
            <div class="kanban-list add-list-container">
                <button class="btn-add-list" id="btnAddList">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add New List
                </button>

                <div class="add-list-form" id="addListForm" style="display: none;">
                    <input type="text" class="form-control" id="newListTitle" placeholder="Enter list title..." />
                    <div class="quick-names mb-3 d-flex gap-2">
                        <span class="badge bg-secondary cursor-pointer" onclick="setListName('To Do')">To Do</span>
                        <span class="badge bg-primary cursor-pointer" onclick="setListName('Doing')">Doing</span>
                        <span class="badge bg-success cursor-pointer" onclick="setListName('Done')">Done</span>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary btn-sm" onclick="saveNewList()">Add List</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelAddList()">Cancel</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div id="task-details-modal-container"></div>

<partial name="~/Views/Tasks/_CreateModal.cshtml"
         model="new Taskify.Models.TaskCreateViewModel { 
                BoardId = Model.Id,
                AvailableMembers=Model.TeamMembers }" />
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initSortable();
        });

        // 1. Cấu hình Kéo thả (SortableJS)
        function initSortable() {
            // Drag Task
            document.querySelectorAll('.list-tasks').forEach(list => {
                new Sortable(list, {
                    group: 'tasks',
                    animation: 150,
                    ghostClass: 'task-ghost',
                    dragClass: 'task-dragging',
                    delay: 100,
                    delayOnTouchOnly: true,
                    onEnd: function (evt) {
                        updateTaskPosition(evt.item.dataset.taskId, evt.to.dataset.listId, evt.newIndex);
                    }
                });
            });

            // Drag List
            var boardEl = document.getElementById('kanbanBoard');
            if(boardEl){
                 new Sortable(boardEl, {
                    animation: 150,
                    handle: '.list-header',
                    filter: '.add-list-container',
                    ghostClass: 'list-ghost',
                    onEnd: function (evt) {
                        updateListOrder(evt.item.dataset.listId, evt.newIndex);
                    }
                });
            }
        }

        // --- API Kéo thả ---
        function updateTaskPosition(taskId, newListId, newIndex) {
            fetch('/Tasks/Move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId, targetListId: newListId, newPosition: newIndex })
            });
        }

        function updateListOrder(listId, newIndex) {
            fetch('/Boards/MoveList', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ BoardId:'@Model.Id', ListId: listId, NewIndex: newIndex })
            }).catch(err => console.error(err));
        }

        // --- CÁC HÀM XỬ LÝ TASK (Quan trọng) ---

        // 2. Mở Modal Thêm Task
        function addTask(listId) {
            const listInput = document.querySelector('#createTaskForm input[name="ListId"]');
            if (listInput) listInput.value = listId;

            const modalEl = document.getElementById('createTaskModal');
            if(modalEl){
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }

        // 3. Mở Modal Chi tiết Task (Xem Details)
        function openTaskDetails(taskId) {
            fetch(`/Tasks/GetDetails/${taskId}`)
                .then(res => {
                    if(!res.ok) throw new Error('Không tải được task');
                    return res.text();
                })
                .then(html => {
                    const container = document.getElementById('task-details-modal-container');
                    container.innerHTML = html;
                    const modalEl = container.querySelector('.modal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                })
                .catch(e => console.error(e));
        }

        // 4. Mở Modal Sửa Task (Edit)
        function editTask(taskId) {
            fetch(`/Tasks/Edit/${taskId}`)
                .then(res => {
                    if (!res.ok) throw new Error("Could not load task");
                    return res.text();
                })
                .then(html => {
                    let container = document.getElementById('edit-task-modal-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'edit-task-modal-container';
                        document.body.appendChild(container);
                    }
                    container.innerHTML = html;
                    const modalEl = container.querySelector('.modal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                })
                .catch(error => console.error(error));
        }

        // 5. Xóa Task
        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            fetch(`/Tasks/Delete/${taskId}`, { method: 'POST' })
            .then(res => {
                if (res.ok) location.reload();
                else alert("Không thể xóa task.");
            });
        }

        // --- CÁC HÀM ASSIGN MEMBER (Mới thêm) ---

        function assignMemberToTask(taskId, userId) {
            fetch(`/Tasks/AssignMember?taskId=${taskId}&userId=${userId}`, { method: 'POST' })
            .then(res => {
                if (res.ok) reloadTaskDetails(taskId);
                else if (res.status === 403) res.json().then(d => alert(d.message));
                else alert("Lỗi hệ thống.");
            });
        }

        function removeAssignee(taskId, userId) {
            if (!confirm("Gỡ thành viên này?")) return;
            fetch(`/Tasks/RemoveMember?taskId=${taskId}&userId=${userId}`, { method: 'POST' })
            .then(res => {
                if (res.ok) reloadTaskDetails(taskId);
                else if (res.status === 403) res.json().then(d => alert(d.message));
                else alert("Lỗi hệ thống.");
            });
        }

        // Hàm reload modal để cập nhật giao diện mà không cần F5
        function reloadTaskDetails(taskId) {
            fetch(`/Tasks/GetDetails/${taskId}`)
                .then(res => res.text())
                .then(html => {
                    const container = document.getElementById('task-details-modal-container');
                    // Chỉ update nội dung modal-content để tránh nhấp nháy
                    const newContent = new DOMParser().parseFromString(html, 'text/html').querySelector('.modal-content').innerHTML;
                    container.querySelector('.modal-content').innerHTML = newContent;
                });
        }

        // --- CÁC HÀM XỬ LÝ LIST ---

        // Toggle Add List Form
        const btnAddList = document.getElementById('btnAddList');
        const formAddList = document.getElementById('addListForm');
        if(btnAddList && formAddList) {
            btnAddList.addEventListener('click', function () {
                this.style.display = 'none';
                formAddList.style.display = 'block';
                document.getElementById('newListTitle').focus();
            });
        }

        function cancelAddList() {
            document.getElementById('addListForm').style.display = 'none';
            document.getElementById('btnAddList').style.display = 'flex';
            document.getElementById('newListTitle').value = '';
        }

        function setListName(name) {
            document.getElementById('newListTitle').value = name;
            document.getElementById('newListTitle').focus();
        }

        function saveNewList() {
            const title = document.getElementById('newListTitle').value.trim();
            if (!title) return;

            fetch('/Boards/CreateList', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ boardId: '@Model.Id', title: title })
            })
            .then(res => {
                if (res.ok) location.reload();
            });
        }

        function deleteList(listId) {
             if (!confirm("Xóa list này?")) return;
             fetch(`/Boards/DeleteList?listId=${listId}`, { method: 'POST' })
             .then(res => {
                 if(res.ok) document.querySelector(`.kanban-list[data-list-id="${listId}"]`).remove();
                 else if(res.status === 403) alert("Không có quyền xóa.");
             });
        }
    </script>
}

