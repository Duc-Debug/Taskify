@model Taskify.Models.ChangePasswordViewModel

@{
    ViewData["Title"] = "Change Password";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-action="Profile">Profile</a>
                    </li>
                    <li class="breadcrumb-item active">Change Password</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="fas fa-key me-2"></i>Change Password
            </h2>
            <p class="text-muted mb-0">Update your password to keep your account secure</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Success/Error Messages -->
            @if (ViewBag.SuccessMessage != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @ViewBag.SuccessMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    @ViewBag.ErrorMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Password Change Form -->
            <div class="card">
                <div class="card-body p-4">
                    <form asp-action="ChangePassword" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Current Password -->
                        <div class="mb-4">
                            <label asp-for="CurrentPassword" class="form-label">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group password-input">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="CurrentPassword" type="password" class="form-control" 
                                       placeholder="Enter current password" id="currentPassword" />
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="togglePasswordVisibility('currentPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger small"></span>
                        </div>

                        <hr class="my-4">

                        <!-- New Password -->
                        <div class="mb-4">
                            <label asp-for="NewPassword" class="form-label">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group password-input">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="NewPassword" type="password" class="form-control" 
                                       placeholder="Enter new password" id="newPassword" 
                                       onkeyup="checkPasswordStrength()" />
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="togglePasswordVisibility('newPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger small"></span>
                            
                            <!-- Password Strength Indicator -->
                            <div class="password-strength mt-2">
                                <div class="password-strength-bar" id="strengthBar"></div>
                            </div>
                            <div class="password-strength-text mt-1" id="strengthText"></div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label asp-for="ConfirmNewPassword" class="form-label">
                                Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group password-input">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="ConfirmNewPassword" type="password" class="form-control" 
                                       placeholder="Re-enter new password" id="confirmNewPassword" 
                                       onkeyup="checkPasswordMatch()" />
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="togglePasswordVisibility('confirmNewPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmNewPassword" class="text-danger small"></span>
                            <div id="passwordMatchMessage" class="small mt-1"></div>
                        </div>

                        <!-- Password Requirements -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Password Requirements
                            </h6>
                            <ul class="mb-0 password-requirements">
                                <li id="req-length">
                                    <i class="fas fa-circle"></i> At least 8 characters
                                </li>
                                <li id="req-uppercase">
                                    <i class="fas fa-circle"></i> At least 1 uppercase letter (A-Z)
                                </li>
                                <li id="req-lowercase">
                                    <i class="fas fa-circle"></i> At least 1 lowercase letter (a-z)
                                </li>
                                <li id="req-number">
                                    <i class="fas fa-circle"></i> At least 1 number (0-9)
                                </li>
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a asp-action="Profile" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card mt-4 border-primary">
                <div class="card-header bg-primary bg-opacity-10 border-primary">
                    <h5 class="mb-0 text-primary">
                        <i class="fas fa-shield-alt me-2"></i>Security Tips
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use a strong password and don't reuse old passwords
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Never share your password with anyone
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Change your password regularly (every 3-6 months)
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Logout when using shared computers
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    
    <script>
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            const icon = button.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password)
            };
            
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);
            
            const metRequirements = Object.values(requirements).filter(Boolean).length;
            let strength = (metRequirements / 5) * 100;
            
            let color = '';
            let message = '';
            
            if (password.length === 0) {
                strengthBar.style.width = '0%';
                strengthText.textContent = '';
                return;
            }
            
            if (strength <= 40) {
                color = '#ef4444';
                message = 'Weak password';
            } else if (strength <= 60) {
                color = '#f59e0b';
                message = 'Fair password';
            } else if (strength < 100) {
                color = '#3b82f6';
                message = 'Good password';
            } else {
                color = '#10b981';
                message = 'Strong password';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.style.backgroundColor = color;
            strengthText.textContent = message;
            strengthText.style.color = color;
            
            checkPasswordMatch();
        }

        function updateRequirement(elementId, isMet) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('i');
            
            if (isMet) {
                element.classList.add('text-success');
                element.classList.remove('text-muted');
                icon.classList.remove('fa-circle');
                icon.classList.add('fa-check-circle');
            } else {
                element.classList.remove('text-success');
                element.classList.add('text-muted');
                icon.classList.add('fa-circle');
                icon.classList.remove('fa-check-circle');
            }
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            const matchMessage = document.getElementById('passwordMatchMessage');
            
            if (confirmPassword === '') {
                matchMessage.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchMessage.textContent = '✓ Passwords match';
                matchMessage.className = 'small mt-1 text-success';
            } else {
                matchMessage.textContent = '✗ Passwords do not match';
                matchMessage.className = 'small mt-1 text-danger';
            }
        }

        document.getElementById('newPassword').addEventListener('input', function() {
            checkPasswordStrength();
        });

        document.getElementById('confirmNewPassword').addEventListener('input', function() {
            checkPasswordMatch();
        });
    </script>
}

<style>
    .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-radius: 15px;
    }

    .password-input .input-group-text {
        background: transparent;
        border-right: none;
    }

    .password-input .form-control {
        border-left: none;
        border-right: none;
    }

    .password-input .btn-outline-secondary {
        border-left: none;
    }

    .password-strength {
        height: 6px;
        background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
    }

    .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
        border-radius: 10px;
    }

    .password-strength-text {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .password-requirements {
        list-style: none;
        padding-left: 0;
    }

    .password-requirements li {
        padding: 5px 0;
        color: #6b7280;
        transition: all 0.3s ease;
    }

    .password-requirements li i {
        width: 20px;
        font-size: 0.8rem;
    }

    .password-requirements li.text-success {
        color: #10b981 !important;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }

    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #6b7280;
    }

    .alert-info {
        background-color: #e0e7ff;
        border-color: #c7d2fe;
        color: #4338ca;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
    }
</style>