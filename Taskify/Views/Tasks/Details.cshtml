@model Taskify.Models.BoardViewModel
@{
    ViewData["Title"] = Model.Name;
}

<div class="kanban-container">
    <div class="board-header">
        <div class="board-info">
            <a asp-action="Index" class="btn-back">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </a>
            <div>
                <h1 class="board-name">@Model.Name</h1>
                <div class="board-meta">
                    <span class="meta-item">@Model.Lists.Count Lists</span>
                    <span class="meta-item">@Model.Lists.Sum(l => l.Tasks.Count) Tasks</span>
                </div>
            </div>
        </div>
    </div>

    <div class="kanban-board" id="kanbanBoard">
        @foreach (var list in Model.Lists.OrderBy(l => l.Order))
        {
            <div class="kanban-list" data-list-id="@list.Id">
                <div class="list-header">
                    <h3 class="list-title">
                        @list.Title
                        <span class="task-count">@list.Tasks.Count</span>
                    </h3>
                    <div class="dropdown">
                        <button class="btn-list-menu" data-bs-toggle="dropdown">•••</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteList('@list.Id')">Delete List</a></li>
                        </ul>
                    </div>
                </div>

                <div class="list-tasks" data-list-id="@list.Id">
                    @foreach (var task in list.Tasks)
                    {
                        <partial name="~/Views/Shared/_TaskCard.cshtml" model="task" />
                    }
                </div>

                <button class="btn-add-task" onclick="openCreateTaskModal('@list.Id')">
                    + Add Task
                </button>
            </div>
        }

        <div class="kanban-list add-list-container">
            <button class="btn-add-list" id="btnAddList">+ Add New List</button>
            <div class="add-list-form" id="addListForm" style="display: none;">
                <input type="text" class="form-control" id="newListTitle" placeholder="Enter list title..." />
                <div class="form-actions mt-2">
                    <button class="btn btn-primary btn-sm" onclick="saveNewList()">Add</button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelAddList()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="task-details-modal-container"></div>

<partial name="~/Views/Tasks/_CreateModal.cshtml"
         model="new Taskify.Models.TaskCreateViewModel { BoardId = Model.Id }" />

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Khởi tạo Kéo thả
            document.querySelectorAll('.list-tasks').forEach(list => {
                new Sortable(list, {
                    group: 'tasks',
                    animation: 150,
                    ghostClass: 'task-ghost',
                    onEnd: function(evt) {
                        updateTaskPosition(evt.item.dataset.taskId, evt.to.dataset.listId, evt.newIndex);
                    }
                });
            });
        });

        // --- 1. XỬ LÝ TẠO TASK MỚI ---
        function openCreateTaskModal(listId) {
            // Gán ListId vào form ẩn trong Modal
            const listInput = document.querySelector('#createTaskForm input[name="ListId"]');
            if (listInput) listInput.value = listId;

            // Mở Modal bằng Bootstrap
            const modalEl = document.getElementById('createTaskModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // --- 2. XỬ LÝ XEM CHI TIẾT TASK ---
        // Hàm này được gọi khi click vào Card (trong file _TaskCard.cshtml)
        function openTaskDetails(taskId) {
            fetch(`/Tasks/GetDetails/${taskId}`)
                .then(res => {
                    if (!res.ok) throw new Error("Lỗi tải chi tiết task");
                    return res.text();
                })
                .then(html => {
                    // Nhúng HTML vào container và bật Modal
                    const container = document.getElementById('task-details-modal-container');
                    container.innerHTML = html;
                    const modal = new bootstrap.Modal(container.querySelector('.modal'));
                    modal.show();
                })
                .catch(err => console.error(err));
        }

        // --- 3. XỬ LÝ KÉO THẢ ---
        function updateTaskPosition(taskId, newListId, newIndex) {
            fetch('/Tasks/Move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId, targetListId: newListId, newPosition: newIndex })
            });
        }

        // --- 4. XỬ LÝ LIST ---
        document.getElementById('btnAddList').addEventListener('click', function() {
            this.style.display = 'none';
            document.getElementById('addListForm').style.display = 'block';
            document.getElementById('newListTitle').focus();
        });

        function cancelAddList() {
            document.getElementById('addListForm').style.display = 'none';
            document.getElementById('btnAddList').style.display = 'flex';
        }

        function saveNewList() {
            const title = document.getElementById('newListTitle').value;
            if(!title) return;
            // Gọi API tạo List (Cần đảm bảo bạn có API này trong BoardsController)
            fetch('/Boards/CreateList', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                 body: `boardId=@Model.Id&title=${encodeURIComponent(title)}`
            }).then(() => location.reload());
        }
    </script>
}

<style>
    /* CSS Của bạn giữ nguyên hoặc thêm vào đây */
    .kanban-container {
        height: calc(100vh - 100px);
        display: flex;
        flex-direction: column;
    }

    .kanban-board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 20px;
        flex: 1;
    }

    .kanban-list {
        min-width: 300px;
        max-width: 300px;
        background: #f8fafc;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
    }

    .list-tasks {
        flex: 1;
        overflow-y: auto;
        min-height: 50px;
    }

    .task-ghost {
        opacity: 0.5;
        background: #e2e8f0;
    }

    .btn-add-task {
        margin-top: 8px;
        width: 100%;
        padding: 8px;
        border: none;
        background: transparent;
        color: #64748b;
        border-radius: 8px;
        text-align: left;
        font-weight: 500;
        transition: 0.2s;
    }

        .btn-add-task:hover {
            background: #e2e8f0;
            color: #0f172a;
        }
</style>